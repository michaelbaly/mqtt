# overview
## 控制报文格式
+ MQTT协议通过交换预定义的MQTT控制报文来**通信**
+ 报文格式：fixed header + var header + payload

## MQTT控制报文
+ CONNECT --- 客户端发送给服务端的第一个报文
+ CONNACK --- 服务端发送给客户端的第一个报文，CONNACK报文没有有效载荷。
+ PUBLISH --- 服务端或客户端传输的应用消息。PUBLISH报文的接收者必须按照根据PUBLISH报文中的QoS等级发送响应
** 客户端使用PUBLISH报文发送应用消息给服务端，目的是分发到其它订阅匹配的客户端。
** 服务端使用PUBLISH报文发送应用消息给每一个订阅匹配的客户端。
+ PUBACK --- PUBACK报文是对**QoS 1**等级的PUBLISH报文的响应。
+ PUBREC --- PUBREC报文是对QoS等级2的PUBLISH报文的响应。它是QoS 2等级协议交换的第二个报文。
+ PUBREL --- PUBREL报文是对PUBREC报文的响应。它是QoS 2等级协议交换的第三个报文。
+ PUBCOMP --- PUBCOMP报文是对PUBREL报文的响应。它是QoS 2等级协议交换的第四个也是**最后一个报文**。
+ SUBSCRIBE --- 客户端向服务端发送SUBSCRIBE报文用于**创建一个或多个订阅**
+ SUBACK --- 服务端发送SUBACK报文给客户端，用于确认它已收到并且正在处理SUBSCRIBE报文。
+ UNSUBSCRIBE --- 客户端发送UNSUBSCRIBE报文给服务端，用于取消订阅主题。
+ UNSUBACK --- 服务端发送UNSUBACK报文给客户端用于确认收到UNSUBSCRIBE报文。
+ PINGREQ --- 客户端发送PINGREQ报文给服务端的。用于：
1. 在没有任何其它控制报文从客户端发给服务的时，告知服务端客户端还活着。
2. 请求服务端发送 响应确认它还活着。
3. 使用网络以确认网络连接没有断开。
+ PINGRESP --- 服务端发送PINGRESP报文响应客户端的PINGREQ报文。表示服务端还活着。
+ DISCONNECT --- DISCONNECT报文是客户端发给服务端的**最后一个控制报文**。表示客户端正常断开连接。

## 操作行为
### 4.1 状态存储
+ 为了提供服务质量保证，客户端和服务端有必要存储会话状态。在整个会话期间，客户端和服务端都必须存储会话状态。
### 4.2 网络连接
+ MQTT协议要求基础传输层能够提供有序的、可靠的、双向传输（从客户端到服务端 和从服务端到客户端）的字节流。
### 4.3 服务质量等级和协议流程
+ MQTT按照这里定义的服务质量 (QoS) 等级分发应用消息。分发协议是对称的
#### 4.3.1 QoS 0:最多分发一次
+ 消息的分发依赖于底层网络的能力。接收者不会发送响应，发送者也不会重试。消息可能送达一次也可能根本没送达。
#### 4.3.2 QoS 1: 至少分发一次
+ 服务质量确保消息至少送达一次。QoS 1的PUBLISH报文的**可变报头**中包含一个报文标识符，需要PUBACK报文确认。
#### 4.3.3 QoS 2: 仅分发一次
+ 这是最高等级的服务质量，消息丢失和重复都是不可接受的。使用这个服务质量等级**会有额外的开销**。
### 4.4 消息分发重试
+ 客户端设置清理会话（CleanSession）标志为0重连时，客户端和服务端必须使用原始的报文标识符重发任何未确认的PUBLISH报文（如果QoS>0）
和PUBREL报文 [MQTT-4.4.0-1]。这是唯一要求客户端或服务端重发消息的情况。
### 4.5 消息收到
+ 服务端接管入站应用消息的所有权时，它必须将消息添加到订阅匹配的客户端的会话状态中。
### 4.6 消息排序

### 4.7 主题名和主题过滤器

### 4.8 错误处理
